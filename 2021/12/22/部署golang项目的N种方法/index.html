<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="yanm1ng&#39;s blog">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      部署golang项目的N种方法 | Solost23&#39;s blog
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  
<link rel="stylesheet" href="/css/style.css">

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
    
<script src="/js/qrious.js"></script>

  
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


  
  
<meta name="generator" content="Hexo 5.4.1"></head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Solost23's blog</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
    
  </div>
</header>

    <div id="article-banner">
  <h2>部署golang项目的N种方法</h2>
  <p class="post-date">2021-12-22</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p>本文以部署<code>Go Web</code>为例，介绍了在<code>CentOs7</code>服务器上部署<code>Golang</code>项目的若干方法</p>
<h3 id="<center>独立部署</center>"><center>独立部署</center></h3>
<p><code>Golang</code>支持跨平台编译，也就是说我们可以在<code>Winodws</code>或<code>Mac</code>平台下编写代码并且将代码编译成能够在<code>Linux amd64</code>服务器上运行的程序。对于简单项目，通常只需要将编译后的二进制文件拷贝到服务器上，然后设置为后台守护进程即可。</p>
<h4 id="<font-color=red>编译</font>"><font color=red>编译</font></h4>
<p>编译可以通过以下命令或编写<code>makefile</code>来操作:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o ./bin/bluebell</span><br></pre></td></tr></table></figure>
<p>下面我们假设将编译好的<code>bluebell</code>二进制文件、配置文件和静态文件上传到服务器的<code>/data/app/bluebell</code>目录下。<br>
<font color=red>注意</font>:如果嫌弃编译后的二进制文件太大，可以在编译的时候加上<code>- ldflags&quot;-s -w&quot;</code>参数去掉符号表和调试信息，一般能减小<code>20%</code>的大小。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags &quot;-s -w&quot; -o ./bin/bluebell</span><br></pre></td></tr></table></figure>
<p>如果还是嫌大的话可以继续使用<code>upx</code>工具对二进制可执行文件进行压缩。我们编译好<code>bluebell</code>项目后，相关必要文件的目录结构如下:</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">├── bin</span><br><span class="line">│   └── bluebell</span><br><span class="line">├── conf</span><br><span class="line">│   └── config.yaml</span><br><span class="line">├── static</span><br><span class="line">│   ├── css</span><br><span class="line">│   │   └── app.0afe9dae.css</span><br><span class="line">│   ├── favicon.ico</span><br><span class="line">│   ├── img</span><br><span class="line">│   │   ├── avatar.7b0a9835.png</span><br><span class="line">│   │   ├── iconfont.cdbe38a0.svg</span><br><span class="line">│   │   ├── logo.da56125f.png</span><br><span class="line">│   │   └── search.8e85063d.png</span><br><span class="line">│   └── js</span><br><span class="line">│       ├── app.9f3efa6d.js</span><br><span class="line">│       ├── app.9f3efa6d.js.map</span><br><span class="line">│       ├── chunk-vendors.57f9e9d6.js</span><br><span class="line">│       └── chunk-vendors.57f9e9d6.js.map</span><br><span class="line">└── templates</span><br><span class="line">    └── index.html</span><br></pre></td></tr></table></figure>
<h4 id="<font-color=red>nohup</font>"><font color=red>nohup</font></h4>
<p><code>nobup</code>用于在系统后台<font color=red>不挂断</font>地运行命令，不刮断指的是退出执行命令的终端也不会影响程序的运行。我们可以使用<code>nohup</code>命令来运行应用程序，使其作为后台守护进程运行。由于在主流的<code>Linux</code>发行版中都会默认安装<code>nohup</code>命令工具，我们可以直接输入以下命令来启动我们的项目:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo nohup ./bin/bluebell conf/config.yaml &gt; nohup_bluebell.log 2&gt;&amp;1 &amp;</span><br><span class="line">其中:</span><br><span class="line">- ./bluebell conf/config.yaml 是我们应用程序的启动命令。</span><br><span class="line">- nohup ... &amp; 表示在后台不挂断的执行上述应用程序的启动命令。</span><br><span class="line">- &gt; nohup_bluebell.log 表示将命令的标准输出重定向到 nohup_bluebell.log 文件。</span><br><span class="line">- 2&gt;&amp;1 表示将标准错误输出也重定向到标准输出中，结合上一条就是把执行命令的输出都定向到 nohup_bluebell.log 文件。</span><br><span class="line"></span><br><span class="line">上面的命令执行后会返回进程id:</span><br><span class="line">```shell</span><br><span class="line">[1] 6338</span><br></pre></td></tr></table></figure>
<p>当然我们也可以通过以下命令来查看<code>bluebell</code>相关活动进程:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep bluebell</span><br></pre></td></tr></table></figure>
<p>输出:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root      6338  4048  0 08:43 pts/0    00:00:00 ./bin/bluebell conf/config.yaml</span><br><span class="line">root      6376  4048  0 08:43 pts/0    00:00:00 grep --color=auto bluebell</span><br></pre></td></tr></table></figure>
<p>此时就可以打开浏览器输入<code>http://服务器公网ip:端口</code>来查看应用端口的展示效果了。</p>
<h4 id="<font-color=red>supervisor</font>"><font color=red>supervisor</font></h4>
<p><code>supervisor</code>是业界流行的一个通用的进程管理程序，它能将一个普通的命令行进程变为后台守护进程，并监控该进程的运行状态，当该进程异常退出的时候能将其自动重启。首先使用<code>yum</code>来安装<code>supervisor</code>,如果你好没有安装过<code>EPEL</code>，可以通过运行下面的命令来完成安装，如果已经安装则跳过此步骤:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install epel-release</span><br></pre></td></tr></table></figure>
<p>安装<code>supervisor</code>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install supervisor</span><br></pre></td></tr></table></figure>
<p><code>supervisor</code>的配置文件为:<code>/etc/supervisord.conf</code>, <code>supervisor</code>所管理的应用的配置文件放在<code>/etc/supervisord.d/</code>目录中，这个目录可以在<code>supervisord.conf</code>中的<code>include</code>配置。</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[include]</span><br><span class="line">files = /etc/supervisord.d/*.conf</span><br></pre></td></tr></table></figure>
<p>启动<code>supervisor</code>服务:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo supervisord -c /etc/supervisord.conf</span><br></pre></td></tr></table></figure>
<p>在<code>/etc/supervisord.d</code>目录下创建一个名为<code>bluebell.conf</code>的配置文件，具体内容如下:</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[program:bluebell]  ;程序名称</span><br><span class="line">user=root  ;执行程序的用户</span><br><span class="line">command=/data/app/bluebell/bin/bluebell /data/app/bluebell/conf/config.yaml  ;执行的命令</span><br><span class="line">directory=/data/app/bluebell/ ;命令执行的目录</span><br><span class="line">stopsignal=TERM  ;重启时发送的信号</span><br><span class="line">autostart=true  </span><br><span class="line">autorestart=true  ;是否自动重启</span><br><span class="line">stdout<span class="built_in">_</span>logfile=/var/log/bluebell-stdout.log  ;标准输出日志位置</span><br><span class="line">stderr<span class="built_in">_</span>logfile=/var/log/bluebell-stderr.log  ;标准错误日志位置</span><br></pre></td></tr></table></figure>
<p>创建好配置文件后，重启<code>supervisor</code>服务:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo supervisorctl update # 更新配置文件并重启相关的程序</span><br></pre></td></tr></table></figure>
<p>查看`bluebell运行状态:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo supervisorctl status bluebell</span><br></pre></td></tr></table></figure>
<p>输出:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bluebell                         RUNNING   pid 10918, uptime 0:05:46</span><br></pre></td></tr></table></figure>
<p>最后补充一下常用的<code>supervisor</code>管理命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl status       # 查看所有任务状态</span><br><span class="line">supervisorctl shutdown     # 关闭所有任务</span><br><span class="line">supervisorctl start 程序名  # 启动任务</span><br><span class="line">supervisorctl stop 程序名   # 关闭任务</span><br><span class="line">supervisorctl reload       # 重启supervisor</span><br></pre></td></tr></table></figure>
<p>接下来就是打开浏览器查看网站是否正常了。</p>
<h3 id="<center>搭配nginx部署</center>"><center>搭配Nginx部署</center></h3>
<p>在需要静态文件分离、需要配置多个域名及证书、需要自建负载均衡层等稍复杂的场景下，我们一般需要搭配第三方的<code>Web</code>服务器(Nginx/Apache)来部署我们的程序。</p>
<h4 id="<font-color=red>正向代理与反向代理</font>"><font color=red>正向代理与反向代理</font></h4>
<p>正向代理可以理解为客户端的代理，你访问墙外的网站用的那个属于正向代理。</p>
<p><img src="images/image-20200920002334065-1024x428.png" alt=""></p>
<p>反向代理可以理解为服务器的代理，通常说的<code>Nginx</code>与<code>Apache</code>就属于反向代理。</p>
<p><img src="images/image-20200920002443846-1024x429.png" alt=""></p>
<p><code>Nginx</code>是一个免费的、开源的、高性能的<code>HTTP</code>和反向代理服务，主要负责负载一些访问量较大的站点。<code>Nginx</code>可以作为一个独立的<code>Web</code>服务，也可以用来给<code>Apache</code>或是其他的<code>Web服务做反向代理。相比于</code>Apache`可以处理更多的并发连接，而且每个连接的内存占用都非常小。</p>
<h4 id="<font-color=red>使用`yum`安装`nginx`"><font color=red>使用<code>yum</code>安装<code>Nginx</code></h4>
<p>EPEL 仓库中有 Nginx 的安装包。如果你还没有安装过 EPEL，可以通过运行下面的命令来完成安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install epel-release</span><br></pre></td></tr></table></figure>
<p>安装<code>nginx</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install nginx</span><br></pre></td></tr></table></figure>
<p>安装完成后，执行下面的命令设置<code>Nginx</code>开机启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable nginx</span><br></pre></td></tr></table></figure>
<p>启动<code>Nginx</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start nginx</span><br></pre></td></tr></table></figure>
<p>查看<code>Nginx</code>运行状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status nginx</span><br></pre></td></tr></table></figure>
<h4 id="<font-color=red>`nginx`配置文件</font>"><font color=red><code>Nginx</code>配置文件</font></h4>
<p>通过上面的方法安装<code>Nginx</code>，所有相关的配置文件都在<code>/etc/nginx/</code>目录中。<code>Nginx</code>的主配置文件是<code>/etc/nginx/nginx.conf</code>。默认还有一个<code>nginx.conf.default</code>的配置文件示例，可以作为参考。你可以为多个服务创建不同的配置文件（建议为每个服务（域名）创建一个单独的配置文件），每一个独立的<code>Nginx</code>服务配置文件都必须以<code>.conf</code>结尾，并存储在<code>/etc/nginx/conf.d</code>目录中。</p>
<h4 id="<font-color=red>`nginx`常用命令</font>"><font color=red><code>Nginx</code>常用命令</font></h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx -s stop    # 停止 Nginx 服务</span><br><span class="line">nginx -s reload  # 重新加载配置文件</span><br><span class="line">nginx -s quit    # 平滑停止 Nginx 服务</span><br><span class="line">nginx -t         # 测试配置文件是否正确</span><br></pre></td></tr></table></figure>
<h4 id="<font-color=red>`nginx`反向代理部署</font>"><font color=red><code>Nginx</code>反向代理部署</font></h4>
<p>推荐使用<code>Nginx</code>作为反向代理来部署我们的程序，按下面的内容修改<code>nginx</code>的配置文件:</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">worker<span class="built_in">_</span>processes  1;</span><br><span class="line"> </span><br><span class="line">events &#123;</span><br><span class="line">    worker<span class="built_in">_</span>connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default<span class="built_in">_</span>type  application/octet-stream;</span><br><span class="line"> </span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive<span class="built_in">_</span>timeout  65;</span><br><span class="line"> </span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server<span class="built_in">_</span>name  localhost;</span><br><span class="line"> </span><br><span class="line">        access<span class="built_in">_</span>log   /var/log/bluebell-access.log;</span><br><span class="line">        error<span class="built_in">_</span>log    /var/log/bluebell-error.log;</span><br><span class="line"> </span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy<span class="built_in">_</span>pass                 http://127.0.0.1:8084;</span><br><span class="line">            proxy<span class="built_in">_</span>redirect             off;</span><br><span class="line">            proxy<span class="built_in">_</span>set<span class="built_in">_</span>header           Host             <span class="built_in">$</span>host;</span><br><span class="line">            proxy<span class="built_in">_</span>set<span class="built_in">_</span>header           X-Real-IP        <span class="built_in">$</span>remote<span class="built_in">_</span>addr;</span><br><span class="line">            proxy<span class="built_in">_</span>set<span class="built_in">_</span>header           X-Forwarded-For  <span class="built_in">$</span>proxy<span class="built_in">_</span>add<span class="built_in">_</span>x<span class="built_in">_</span>forwarded<span class="built_in">_</span>for;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行下面的命令检查配置文件语法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br></pre></td></tr></table></figure>
<p>执行下面的命令重新加载配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>
<p>接下来就是打开浏览器来查看网站是否正常了。当然我们还可以使用<code>nginx</code>的<code>upstream</code>配置来添加多个服务器地址实现负载均衡。</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">worker<span class="built_in">_</span>processes  1;</span><br><span class="line"> </span><br><span class="line">events &#123;</span><br><span class="line">    worker<span class="built_in">_</span>connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default<span class="built_in">_</span>type  application/octet-stream;</span><br><span class="line"> </span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive<span class="built_in">_</span>timeout  65;</span><br><span class="line"> </span><br><span class="line">    upstream backend &#123;</span><br><span class="line">      server 127.0.0.1:8084;</span><br><span class="line">      <span class="params">#</span> 这里需要填真实可用的地址，默认轮询</span><br><span class="line">      <span class="params">#</span>server backend1.example.com;</span><br><span class="line">      <span class="params">#</span>server backend2.example.com;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server<span class="built_in">_</span>name  localhost;</span><br><span class="line"> </span><br><span class="line">        access<span class="built_in">_</span>log   /var/log/bluebell-access.log;</span><br><span class="line">        error<span class="built_in">_</span>log    /var/log/bluebell-error.log;</span><br><span class="line"> </span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy<span class="built_in">_</span>pass                 http://backend/;</span><br><span class="line">            proxy<span class="built_in">_</span>redirect             off;</span><br><span class="line">            proxy<span class="built_in">_</span>set<span class="built_in">_</span>header           Host             <span class="built_in">$</span>host;</span><br><span class="line">            proxy<span class="built_in">_</span>set<span class="built_in">_</span>header           X-Real-IP        <span class="built_in">$</span>remote<span class="built_in">_</span>addr;</span><br><span class="line">            proxy<span class="built_in">_</span>set<span class="built_in">_</span>header           X-Forwarded-For  <span class="built_in">$</span>proxy<span class="built_in">_</span>add<span class="built_in">_</span>x<span class="built_in">_</span>forwarded<span class="built_in">_</span>for;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="<font-color=red>`nginx`分离静态文件请求</font>"><font color=red><code>Nginx</code>分离静态文件请求</font></h4>
<p>上面的配置是简单的使用<code>Nginx</code>作为反向代理处理所有的请求并转发给我们的<code>Go</code>程序处理，其实我们还可以有选择的将静态文件部分的请求直接用<code>nginx</code>处理，而将<code>API</code>接口类的动态处理请求转发给后端的<code>Go</code>程序来处理。</p>
<p><img src="images/image-20200920002735894-1024x256.png" alt=""></p>
<p>继续修改我们的<code>Nginx</code>配置文件来实现上述功能:</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">worker<span class="built_in">_</span>processes  1;</span><br><span class="line"> </span><br><span class="line">events &#123;</span><br><span class="line">    worker<span class="built_in">_</span>connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default<span class="built_in">_</span>type  application/octet-stream;</span><br><span class="line"> </span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive<span class="built_in">_</span>timeout  65;</span><br><span class="line"> </span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server<span class="built_in">_</span>name  bluebell;</span><br><span class="line"> </span><br><span class="line">        access<span class="built_in">_</span>log   /var/log/bluebell-access.log;</span><br><span class="line">        error<span class="built_in">_</span>log    /var/log/bluebell-error.log;</span><br><span class="line"> </span><br><span class="line">		<span class="params">#</span> 静态文件请求</span><br><span class="line">        location ~ .*<span class="keyword">\.</span>(gif|jpg|jpeg|png|js|css|eot|ttf|woff|svg|otf)<span class="built_in">$</span> &#123;</span><br><span class="line">            access<span class="built_in">_</span>log off;</span><br><span class="line">            expires    1d;</span><br><span class="line">            root       /data/app/bluebell;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="params">#</span> index.html页面请求</span><br><span class="line">        <span class="params">#</span> 因为是单页面应用这里使用 try<span class="built_in">_</span>files 处理一下，避免刷新页面时出现404的问题</span><br><span class="line">        location / &#123;</span><br><span class="line">            root /data/app/bluebell/templates;</span><br><span class="line">            index index.html;</span><br><span class="line">            try<span class="built_in">_</span>files <span class="built_in">$</span>uri <span class="built_in">$</span>uri/ /index.html;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">		<span class="params">#</span> API请求</span><br><span class="line">        location /api &#123;</span><br><span class="line">            proxy<span class="built_in">_</span>pass                 http://127.0.0.1:8084;</span><br><span class="line">            proxy<span class="built_in">_</span>redirect             off;</span><br><span class="line">            proxy<span class="built_in">_</span>set<span class="built_in">_</span>header           Host             <span class="built_in">$</span>host;</span><br><span class="line">            proxy<span class="built_in">_</span>set<span class="built_in">_</span>header           X-Real-IP        <span class="built_in">$</span>remote<span class="built_in">_</span>addr;</span><br><span class="line">            proxy<span class="built_in">_</span>set<span class="built_in">_</span>header           X-Forwarded-For  <span class="built_in">$</span>proxy<span class="built_in">_</span>add<span class="built_in">_</span>x<span class="built_in">_</span>forwarded<span class="built_in">_</span>for;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="<font-color=red>前后端分开部署</font>"><font color=red>前后端分开部署</font></h4>
<p>前后端的代码没必要部署到相同的服务器上，也可以分开部署到不同的服务器上，下图是前端服务将<code>API</code>请求转发至后端服务的方案。</p>
<p><img src="images/image-20200920003753373-1024x419.png" alt=""></p>
<p>上面的部署方案中，所有浏览器的请求都是直接访问前端服务，而如果是浏览器直接访问后端<code>API</code>服务的部署模式下，如下图。此时前端和后端通常不在同一个域下，我们还需要在后端代码中添加跨域支持。</p>
<p><img src="images/image-20200920003335577-1024x406.png" alt=""></p>
<p>这里使用 <a target="_blank" rel="noopener" href="http://github.com/gin-contrib/cors">github.com/gin-contrib/cors</a> 库来支持跨域请求。<br>
最简单的允许跨域的配置是使用<code>cors.Default ()</code>，它默认允许所有跨域请求。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	router := gin.Default()</span><br><span class="line">	<span class="comment">// same as</span></span><br><span class="line">	<span class="comment">// config := cors.DefaultConfig()</span></span><br><span class="line">	<span class="comment">// config.AllowAllOrigins = true</span></span><br><span class="line">	<span class="comment">// router.Use(cors.New(config))</span></span><br><span class="line">	router.Use(cors.Default())</span><br><span class="line">	router.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此外，还可以使用<code>cors.Config</code>自定义具体的跨域请求相关配置项：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"> </span><br><span class="line">	<span class="string">&quot;github.com/gin-contrib/cors&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	router := gin.Default()</span><br><span class="line">	<span class="comment">// CORS for https://foo.com and https://github.com origins, allowing:</span></span><br><span class="line">	<span class="comment">// - PUT and PATCH methods</span></span><br><span class="line">	<span class="comment">// - Origin header</span></span><br><span class="line">	<span class="comment">// - Credentials share</span></span><br><span class="line">	<span class="comment">// - Preflight requests cached for 12 hours</span></span><br><span class="line">	router.Use(cors.New(cors.Config&#123;</span><br><span class="line">		AllowOrigins:     []<span class="keyword">string</span>&#123;<span class="string">&quot;https://foo.com&quot;</span>&#125;,</span><br><span class="line">		AllowMethods:     []<span class="keyword">string</span>&#123;<span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;PATCH&quot;</span>&#125;,</span><br><span class="line">		AllowHeaders:     []<span class="keyword">string</span>&#123;<span class="string">&quot;Origin&quot;</span>&#125;,</span><br><span class="line">		ExposeHeaders:    []<span class="keyword">string</span>&#123;<span class="string">&quot;Content-Length&quot;</span>&#125;,</span><br><span class="line">		AllowCredentials: <span class="literal">true</span>,</span><br><span class="line">		AllowOriginFunc: <span class="function"><span class="keyword">func</span><span class="params">(origin <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">			<span class="keyword">return</span> origin == <span class="string">&quot;https://github.com&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">		MaxAge: <span class="number">12</span> * time.Hour,</span><br><span class="line">	&#125;))</span><br><span class="line">	router.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="<font-color=red>容器部署</font>"><font color=red>容器部署</font></h3>
<p>参考:<a target="_blank" rel="noopener" href="https://solost23.github.io/2021/12/22/%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2go%20web%E5%BA%94%E7%94%A8/">使用Docker与Docker Compose部署Go Web应用</a></p>
<h3 id="<font-color=red>关于bluebell</font>"><font color=red>关于bluebell</font></h3>
<p>下载链接:<a target="_blank" rel="noopener" href="https://github.com/Solost23/bubble">https://github.com/Solost23/bubble</a></p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#golang" >
    <span class="tag-code">golang</span>
  </a>

  <a href="/tags#docker" >
    <span class="tag-code">docker</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2021/12/21/Cookie%E4%B8%8ESession/">
        <span class="nav-arrow">← </span>
        
          Cookie与Session
        
      </a>
    
    
      <a class="nav-right" href="/2021/12/22/%E4%BD%BF%E7%94%A8docker%E9%83%A8%E7%BD%B2go%20web%E5%BA%94%E7%94%A8/">
        
          使用Docker部署Go Web程序
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
      <div class="money-like">
        <div class="reward-btn">
          赏
          <span class="money-code">
            <span class="alipay-code">
              <div class="code-image"></div>
              <b>使用支付宝打赏</b>
            </span>
            <span class="wechat-code">
              <div class="code-image"></div>
              <b>使用微信打赏</b>
            </span>
          </span>
        </div>
        <p class="notice">若你觉得我的文章对你有帮助，欢迎点击上方按钮对我打赏</p>
      </div>
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
      <div class="qrcode">
        <canvas id="share-qrcode"></canvas>
        <p class="notice">扫描二维码，分享此文章</p>
      </div>
    
    <!-- 二维码 END -->
    
      <!-- Utterances START -->
      <div id="utterances"></div>
      <script src="https://utteranc.es/client.js"
        repo=""
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script>    
      <!-- Utterances END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%3Ccenter%3E%E7%8B%AC%E7%AB%8B%E9%83%A8%E7%BD%B2%3C/center%3E"><span class="toc-nav-text">独立部署</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%3Cfont-color=red%3E%E7%BC%96%E8%AF%91%3C/font%3E"><span class="toc-nav-text">编译</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%3Cfont-color=red%3Enohup%3C/font%3E"><span class="toc-nav-text">nohup</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%3Cfont-color=red%3Esupervisor%3C/font%3E"><span class="toc-nav-text">supervisor</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%3Ccenter%3E%E6%90%AD%E9%85%8Dnginx%E9%83%A8%E7%BD%B2%3C/center%3E"><span class="toc-nav-text">搭配Nginx部署</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%3Cfont-color=red%3E%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%3C/font%3E"><span class="toc-nav-text">正向代理与反向代理</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%3Cfont-color=red%3E%E4%BD%BF%E7%94%A8%60yum%60%E5%AE%89%E8%A3%85%60nginx%60"><span class="toc-nav-text">使用yum安装Nginx</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%3Cfont-color=red%3E%60nginx%60%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%3C/font%3E"><span class="toc-nav-text">Nginx配置文件</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%3Cfont-color=red%3E%60nginx%60%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%3C/font%3E"><span class="toc-nav-text">Nginx常用命令</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%3Cfont-color=red%3E%60nginx%60%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%83%A8%E7%BD%B2%3C/font%3E"><span class="toc-nav-text">Nginx反向代理部署</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%3Cfont-color=red%3E%60nginx%60%E5%88%86%E7%A6%BB%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E8%AF%B7%E6%B1%82%3C/font%3E"><span class="toc-nav-text">Nginx分离静态文件请求</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%3Cfont-color=red%3E%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E5%BC%80%E9%83%A8%E7%BD%B2%3C/font%3E"><span class="toc-nav-text">前后端分开部署</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%3Cfont-color=red%3E%E5%AE%B9%E5%99%A8%E9%83%A8%E7%BD%B2%3C/font%3E"><span class="toc-nav-text">容器部署</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%3Cfont-color=red%3E%E5%85%B3%E4%BA%8Ebluebell%3C/font%3E"><span class="toc-nav-text">关于bluebell</span></a></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://example.com/2021/12/22/部署golang项目的N种方法/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', '/css/images/error_icon.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== '/css/images/error_icon.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>


  <script>
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });
  </script>






    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2022 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a target="_blank" rel="noopener" href="https://github.com/yanm1ng">yanm1ng</a>
    
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      hljs.configure({useBR: true});
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>


  </body>
</html>